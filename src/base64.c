#include "base64.h"
#include <stdint.h>
#include <stdio.h>

unsigned char *ribs_base64_encode(void *dst, size_t *dstsize, const void *src, size_t srcsize, int padding) {
    printf("here\n");
    static const char *code = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";
    *dstsize = 0;
    size_t total_chars = srcsize / 3;
    size_t left_chars = srcsize - (total_chars * 3);
    const unsigned char *s = src;
    unsigned char *d = dst;
    size_t i;
    for (i = 0; i < total_chars; ++i) {
        unsigned long data = *s++ << 16;
        data |= *s++ << 8;
        data |= *s++;
        *d++ = code[data >> 18];
        *d++ = code[(data >> 12) & 0x3F];
        *d++ = code[(data >> 6) & 0x3F];
        *d++ = code[data & 0x3F];
    }
    unsigned long data;
    switch (left_chars) {
    case 1:
        *d++ = code[*s >> 2];
        *d++ = code[(*s & 0x3) << 4];
        if (padding) {
            *d++ = '=';
            *d++ = '=';
        }
        break;
    case 2:
        data = *s++ << 8;
        data |= *s++;
        *d++ = code[data >> 10];
        *d++ = code[(data >> 4) & 0x3F];
        *d++ = code[(data & 0xF) << 2];
        if (padding)
            *d++ = '=';
        break;
    }
    *d = 0;
    *dstsize = d - (unsigned char *)dst;
    return dst;
}

unsigned char *ribs_base64_decode(void *dst, size_t *dstsize, const void *src, size_t srcsize) {
    static const uint8_t decoder[] = {
        0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
        0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
        0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x3e,0xff,0xff,
        0x34,0x35,0x36,0x37,0x38,0x39,0x3a,0x3b,0x3c,0x3d,0xff,0xff,0xff,0xff,0xff,0xff,
        0xff,0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0a,0x0b,0x0c,0x0d,0x0e,
        0x0f,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0xff,0xff,0xff,0xff,0x3f,
        0xff,0x1a,0x1b,0x1c,0x1d,0x1e,0x1f,0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,
        0x29,0x2a,0x2b,0x2c,0x2d,0x2e,0x2f,0x30,0x31,0x32,0x33,0xff,0xff,0xff,0xff,0xff,
        0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
        0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
        0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
        0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
        0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
        0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
        0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
        0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff };
    const unsigned char *s = src;
    if (srcsize > 2 && s[srcsize-2] == '=')
        srcsize -= 2;
    else if (srcsize > 1 && s[srcsize-1] == '=')
        --srcsize;
    size_t total_chars = srcsize / 4;
    size_t left_chars = srcsize - (total_chars * 4);
    unsigned char *d = dst;
    size_t i;
    for (i = 0; i < total_chars; ++i) {
        uint32_t data = decoder[(*s++)] << 18;
        data |= decoder[(*s++)] << 12;
        data |= decoder[(*s++)] << 6;
        data |= decoder[(*s++)];
        *d++ = (data >> 16);
        *d++ = (data >> 8);
        *d++ = data;
    }
    uint32_t data;
    switch (left_chars) {
    case 1:
        break;
    case 2:
        data = decoder[(*s++)] << 6;
        data |= decoder[(*s++)];
        *d++ = data >> 4;
        break;
    case 3:
        data = decoder[(*s++)] << 12;
        data |= decoder[(*s++)] << 6;
        data |= decoder[(*s++)];
        *d++ = data >> 10;
        *d++ = data >> 2;
        break;
    }
    *d = 0;
    *dstsize = d - (unsigned char *)dst;
    return dst;
}

